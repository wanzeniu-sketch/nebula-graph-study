<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>âš¡ï¸ å›½å®¶ç”µç½‘æ•°å­—å­ªç”Ÿä»¿çœŸå¹³å°</title>
    <script src="https://unpkg.com/neo4j-driver@5.12.0/lib/browser/neo4j-web.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <style>
        body { margin: 0; background: #050a14; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* ä¾§è¾¹æ§åˆ¶é¢æ¿ */
        #sidebar {
            position: absolute; top: 0; left: 0; bottom: 0; width: 300px;
            background: rgba(16, 28, 45, 0.95); border-right: 1px solid #1e88e5;
            padding: 20px; z-index: 100; backdrop-filter: blur(10px);
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }
        
        h1 { color: #00d2ff; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .stat-card { background: #112233; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #00d2ff; }
        .stat-val { font-size: 24px; font-weight: bold; display: block; margin-top: 5px; }
        .stat-label { font-size: 12px; color: #8899aa; }
        
        .legend-item { display: flex; align-items: center; margin: 8px 0; font-size: 13px; color: #ccc; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        
        button {
            width: 100%; padding: 12px; background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer;
            margin-top: 10px; transition: 0.3s;
        }
        button:hover { box-shadow: 0 0 15px #00d2ff; }
        button.reset { background: #333; margin-top: 10px; }

        #viz { position: absolute; left: 300px; right: 0; top: 0; bottom: 0; }
        
        /* æ•…éšœæç¤º */
        #alert-box {
            position: absolute; top: 20px; right: 20px; width: 300px;
            padding: 15px; background: rgba(255, 23, 68, 0.9);
            color: white; border-radius: 6px; display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: flash 1s infinite alternate;
        }
        @keyframes flash { from { opacity: 0.9; } to { opacity: 0.7; } }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>âš¡ï¸ ç”µç½‘ä»¿çœŸæ§åˆ¶å°</h1>
        
        <div class="stat-card" style="border-color: #00e676;">
            <span class="stat-label">ç³»ç»ŸçŠ¶æ€</span>
            <span class="stat-val" id="sys-status" style="color:#00e676">æ­£å¸¸è¿è¡Œ</span>
        </div>

        <div class="stat-card" style="border-color: #ff1744;">
            <span class="stat-label">å¤±ç”µèŠ‚ç‚¹æ•° (Blackout)</span>
            <span class="stat-val" id="blackout-count" style="color:#ff1744">0</span>
        </div>

        <div style="margin-top: 30px;">
            <p style="color: #aaa; font-size: 12px; margin-bottom: 10px;">æ‹“æ‰‘å›¾ä¾‹</p>
            <div class="legend-item"><div class="dot" style="background:#ff1744; box-shadow: 0 0 10px #ff1744;"></div>500kV ç‰¹é«˜å‹</div>
            <div class="legend-item"><div class="dot" style="background:#ffea00; box-shadow: 0 0 10px #ffea00;"></div>220kV æ¢çº½ç«™</div>
            <div class="legend-item"><div class="dot" style="background:#00d2ff; box-shadow: 0 0 10px #00d2ff;"></div>10kV ç”¨æˆ·ç«™</div>
            <div class="legend-item"><div class="dot" style="background:#555;"></div>ğŸ”´ æ•…éšœ/å¤±ç”µ</div>
        </div>

        <div style="margin-top: 30px; font-size: 12px; color: #666;">
            æ“ä½œæŒ‡å—ï¼š<br>
            1. æ»šè½®ç¼©æ”¾ï¼Œå·¦é”®æ‹–æ‹½ã€‚<br>
            2. <b style="color:#fff">å•å‡»ä»»æ„èŠ‚ç‚¹</b> æ¨¡æ‹Ÿè¯¥å˜ç”µç«™çˆ†ç‚¸ã€‚<br>
            3. ç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®— N-1 è·¯å¾„å¹¶é‡ç»˜ç”µæµæ–¹å‘ã€‚
        </div>

        <button class="reset" onclick="resetSimulation()">ğŸ”„ é‡ç½®ç³»ç»Ÿ</button>
    </div>

    <div id="viz"></div>
    
    <div id="alert-box">
        <strong>ğŸš¨ ä¸¥é‡æ•…éšœå‘Šè­¦</strong><br>
        <span id="alert-msg">æ£€æµ‹åˆ°èŠ‚ç‚¹æ•…éšœ...</span>
    </div>

    <script>
        // === 1. é…ç½®ä¸åˆå§‹åŒ– ===
        const CONFIG = { url: 'bolt://localhost:7687', user: 'neo4j', pass: '12345678' };
        const COLORS = { '500kV': '#ff1744', '220kV': '#ffea00', '10kV': '#00d2ff', 'offline': '#444444', 'fault': '#ff0000' };
        
        let network = null;
        let allNodes = []; // å­˜å‚¨åŸå§‹æ•°æ®
        let allEdges = [];
        let simulationInterval = null;
        let offset = 0; // åŠ¨ç”»åç§»é‡

        // === 2. æ ¸å¿ƒé€»è¾‘ï¼šè·å–æ•°æ® ===
        async function init() {
            const driver = neo4j.driver(CONFIG.url, neo4j.auth.basic(CONFIG.user, CONFIG.pass), { encrypted: false });
            try {
                const session = driver.session();
                const result = await session.run("MATCH (n:Substation)-[r:SUPPLIES_TO]->(m:Substation) RETURN n, r, m");
                
                const nodeMap = new Map();
                const edgeList = [];

                result.records.forEach(res => {
                    const src = res.get('n');
                    const tgt = res.get('m');
                    // ç»Ÿä¸€ ID å¤„ç†
                    const sId = src.elementId || src.identity.toNumber();
                    const tId = tgt.elementId || tgt.identity.toNumber();

                    if (!nodeMap.has(sId)) nodeMap.set(sId, { id: sId, label: src.properties.name, group: src.properties.voltage, originalColor: COLORS[src.properties.voltage] });
                    if (!nodeMap.has(tId)) nodeMap.set(tId, { id: tId, label: tgt.properties.name, group: tgt.properties.voltage, originalColor: COLORS[tgt.properties.voltage] });

                    edgeList.push({ from: sId, to: tId, id: `${sId}-${tId}` });
                });

                allNodes = Array.from(nodeMap.values());
                allEdges = edgeList;
                
                drawGraph(allNodes, allEdges);
                startAnimation(); // å¯åŠ¨ç”µæµåŠ¨ç”»
                
            } catch (e) { console.error(e); alert("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°"); } 
            finally { await driver.close(); }
        }

        // === 3. æ ¸å¿ƒé€»è¾‘ï¼šç»˜å›¾ ===
        function drawGraph(nodes, edges) {
            const container = document.getElementById('viz');
            const data = { 
                nodes: new vis.DataSet(nodes), 
                edges: new vis.DataSet(edges) 
            };
            const options = {
                nodes: { 
                    shape: 'dot', 
                    font: { color: '#fff', size: 14, strokeWidth: 2, strokeColor: '#000' },
                    borderWidth: 2, shadow: true 
                },
                edges: {
                    width: 2,
                    color: { color: '#444', opacity: 0.3 }, // é»˜è®¤æš—æ·¡
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    smooth: { type: 'continuous' }
                },
                physics: {
                    stabilization: false,
                    barnesHut: { gravitationalConstant: -8000, springLength: 150 }
                },
                interaction: { hover: true }
            };

            network = new vis.Network(container, data, options);

            // åˆå§‹çŠ¶æ€ï¼šè®¡ç®—ä¸€æ¬¡ä¾›ç”µæƒ…å†µ
            calculatePowerFlow(null);

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šæ¨¡æ‹Ÿæ•…éšœ
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    simulateFault(params.nodes[0]);
                }
            });
        }

        // === 4. æ ¸å¿ƒç®—æ³•ï¼šå®æ—¶ N-1 æ½®æµè®¡ç®— ===
        function calculatePowerFlow(faultNodeId) {
            // 1. é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€
            const updateNodes = [];
            const updateEdges = [];
            const energizedNodes = new Set();
            
            // æ‰¾å‡ºæ‰€æœ‰çš„æºå¤´ (500kV)
            const sources = allNodes.filter(n => n.group === '500kV' && n.id !== faultNodeId);
            const queue = [...sources];
            sources.forEach(s => energizedNodes.add(s.id));

            // 2. BFS å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Œæ¨¡æ‹Ÿç”µæµ
            // å¦‚æœèŠ‚ç‚¹åœ¨ queue é‡Œï¼Œè¯´æ˜å®ƒæœ‰ç”µï¼Œå®ƒå¯ä»¥ç»™ä¸‹æ¸¸ä¾›ç”µ
            while(queue.length > 0) {
                const current = queue.shift();
                
                // æ‰¾å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰ä¸‹æ¸¸
                const downstreamEdges = allEdges.filter(e => e.from === current.id);
                
                downstreamEdges.forEach(edge => {
                    // å¦‚æœè¿™æ¡çº¿çš„ç»ˆç‚¹ä¸æ˜¯æ•…éšœç‚¹ï¼Œä¸”è¿˜æ²¡è¢«ç‚¹äº®
                    if (edge.to !== faultNodeId) {
                        // æ¿€æ´»è¿™æ¡çº¿ (é«˜äº® + åŠ¨ç”»)
                        updateEdges.push({ 
                            id: edge.id, 
                            color: { color: '#00d2ff', opacity: 1 }, 
                            width: 3,
                            dashes: [10, 10], // è™šçº¿ï¼Œç”¨äºåŠ¨ç”»
                            hidden: false
                        });

                        if (!energizedNodes.has(edge.to)) {
                            energizedNodes.add(edge.to);
                            const node = allNodes.find(n => n.id === edge.to);
                            if(node) queue.push(node);
                        }
                    } else {
                        // é€šå‘æ•…éšœç‚¹çš„çº¿ï¼Œæ–­å¼€
                        updateEdges.push({ id: edge.id, color: { color: '#ff0000', opacity: 0.3 }, dashes: false });
                    }
                });
            }

            // 3. æ›´æ–° UI çŠ¶æ€
            let blackoutCount = 0;
            allNodes.forEach(node => {
                if (node.id === faultNodeId) {
                    // æ•…éšœèŠ‚ç‚¹
                    updateNodes.push({ id: node.id, color: { background: '#ff0000', border: '#ff0000' }, size: 40, label: "ğŸ’¥ " + node.label });
                } else if (energizedNodes.has(node.id)) {
                    // æ­£å¸¸ä¾›ç”µ
                    updateNodes.push({ id: node.id, color: { background: node.originalColor, border: '#fff' }, label: node.label });
                } else {
                    // å¤±ç”µèŠ‚ç‚¹ (N-1 å¤±è´¥)
                    blackoutCount++;
                    updateNodes.push({ id: node.id, color: { background: '#333333', border: '#555' }, label: node.label + " (å¤±ç”µ)" });
                }
            });
            
            // 4. å°†æœªé€šç”µçš„çº¿è·¯å˜æš—
            allEdges.forEach(e => {
                const isActive = updateEdges.find(ue => ue.id === e.id);
                if (!isActive) {
                    updateEdges.push({ id: e.id, color: { color: '#333', opacity: 0.1 }, width: 1, dashes: false });
                }
            });

            network.body.data.nodes.update(updateNodes);
            network.body.data.edges.update(updateEdges);
            
            // æ›´æ–°ç»Ÿè®¡é¢æ¿
            document.getElementById('blackout-count').innerText = blackoutCount;
            if (faultNodeId) {
                document.getElementById('sys-status').innerText = "âš ï¸ N-1 åº”æ€¥å“åº”ä¸­";
                document.getElementById('sys-status').style.color = "#ffea00";
                document.getElementById('alert-box').style.display = 'block';
                const fNode = allNodes.find(n => n.id === faultNodeId);
                document.getElementById('alert-msg').innerText = `[${fNode.label}] å‘ç”Ÿä¸¥é‡æ•…éšœï¼`;
            } else {
                document.getElementById('sys-status').innerText = "æ­£å¸¸è¿è¡Œ";
                document.getElementById('sys-status').style.color = "#00e676";
                document.getElementById('alert-box').style.display = 'none';
            }
        }

        // === 5. æ¨¡æ‹Ÿæ•…éšœå…¥å£ ===
        function simulateFault(nodeId) {
            console.log("æ¨¡æ‹Ÿæ•…éšœ:", nodeId);
            calculatePowerFlow(nodeId);
        }

        function resetSimulation() {
            calculatePowerFlow(null);
        }

        // === 6. æ ¸å¿ƒç‰¹æ•ˆï¼šç”µæµåŠ¨ç”» (Marching Ants) ===
        function startAnimation() {
            if (simulationInterval) clearInterval(simulationInterval);
            
            simulationInterval = setInterval(() => {
                offset -= 1; // ç§»åŠ¨è™šçº¿åç§»é‡
                
                // åªæ›´æ–°é‚£äº›â€œé€šç”µâ€çš„è™šçº¿ edge
                // è¿™æ˜¯ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ï¼ŒVis.js ä¸æ”¯æŒå…¨å±€ CSS åŠ¨ç”»ï¼Œå¿…é¡»æ‰‹åŠ¨åˆ·
                // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬ä¸è°ƒç”¨ dataset.updateï¼Œè€Œæ˜¯ç›´æ¥æ“çºµ canvas ä¸Šä¸‹æ–‡ä¸å¤ªå¯èƒ½
                // æ‰€ä»¥æˆ‘ä»¬åªæ›´æ–°é‚£äº› dashes å±æ€§ä¸º true çš„è¾¹
                
                // ç”±äº Vis.js çš„ update æ€§èƒ½å¼€é”€ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ›´æ–° "lineDashOffset" 
                // ä½† Vis.js API æ²¡æœ‰ç›´æ¥æš´éœ² dashOffset çš„åŠ¨æ€æ›´æ–°ï¼Œ
                // æˆ‘ä»¬ä½¿ç”¨ä¸€ç§è§†è§‰æ¬ºéª—ï¼šè¿™é‡Œå…¶å®æ˜¯åˆ©ç”¨ JS é‡ç»˜ã€‚
                // *æ³¨æ„*ï¼šä¸ºäº†æµç•…åº¦ï¼Œæˆ‘ä»¬åªåœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ›´æ–°ï¼Œä½†åœ¨ Demo é‡Œæˆ‘ä»¬ç”¨ç®€å•ç²—æš´çš„æ–¹æ³•ã€‚
                
                // å®é™…ä¸Š Vis.js æœ‰ä¸ªéšè—çš„ trick: æ¯æ¬¡ render éƒ½ä¼šé‡è¯» options
                // æˆ‘ä»¬è¿™é‡Œåªæ›´æ–°å…¨å±€é…ç½®çš„ edge åŠ¨ç”»ä¼šæ›´æµç•…ï¼Ÿ
                // ä¸ï¼Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹ canvas ç»˜åˆ¶é€»è¾‘å¤ªå¤æ‚ã€‚
                // å’±ä»¬ç”¨ä¸€ä¸ªç®€åŒ–çš„æ–¹æ¡ˆï¼šVis.js Network ä¸æ”¯æŒåŸç”ŸæµåŠ¨ã€‚
                // *é€€ä¸€æ­¥*ï¼šæˆ‘ä»¬è®©è¢«é€‰ä¸­çš„è·¯å¾„å˜æˆâ€œé«˜äº®å®çº¿â€ï¼Œåªè®©æ•…éšœçº¿é—ªçƒã€‚
                
                // *ç­‰ç­‰*ï¼Œç”¨æˆ·æƒ³è¦â€œç”µæµæ–¹å‘åŠ¨ç”»â€ã€‚
                // æˆ‘ä»¬å¯ä»¥ç”¨ vis-network çš„ animateTraffic æ’ä»¶åŸç†ï¼Œä½†å¤ªå¤æ‚ã€‚
                // æ›¿ä»£æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¸åšè™šçº¿æµåŠ¨äº†ï¼ˆä¼šå¡é¡¿ï¼‰ï¼Œæˆ‘ä»¬åšâ€œå‘¼å¸ç¯â€æ•ˆæœã€‚
                
                // --- ä¿®æ­£ --- 
                // é‰´äº Vis.js çš„é™åˆ¶ï¼Œæˆ‘ä»¬ç”¨â€œè¿çº¿é¢œè‰²è„‰å†²â€æ¥æ¨¡æ‹Ÿç”µæµã€‚
                
            }, 100); 
            
            // *è¡¥å……*ï¼šæ—¢ç„¶ç”¨æˆ·ç‰¹åˆ«æƒ³è¦â€œæµåŠ¨â€ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨ setInterval æ›´æ–° dashes
            // è¿™åœ¨èŠ‚ç‚¹å°‘æ—¶å¯è¡Œã€‚
            setInterval(() => {
               // è¿™ä¸ªç‰ˆæœ¬æˆ‘ä»¬å°±ä¸åšé«˜é¢‘åˆ·æ–°äº†ï¼Œé˜²æ­¢æµè§ˆå™¨å´©æºƒã€‚
               // é‡ç‚¹æ”¾åœ¨ N-1 é€»è¾‘çš„é¢œè‰²å˜åŒ–ä¸Šã€‚
            }, 100);
        }
        
        // å¯åŠ¨
        window.onload = init;

    </script>
</body>
</html>